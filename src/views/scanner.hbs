<div class="container text-center">
  <h1 class="mt-4">Escanear Código QR</h1>
  <p>Usa tu cámara para escanear el código QR de un asistente.</p>

  <div id="reader" class="mx-auto" style="width: 300px;"></div>
  <p id="qr-result" class="mt-3 fw-bold"></p>

  <div id="user-info" class="mt-4">
    <!-- Aquí se mostrarán los detalles del usuario después de escanear el código QR -->
  </div>

  <a href="/" class="btn btn-primary mt-3">Volver al Inicio</a>
</div>

<!-- Script para el escáner QR -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  function onScanSuccess(decodedText, decodedResult) {
    // Mostrar el ID escaneado
    const qrResultElement = document.getElementById("qr-result");
    qrResultElement.innerText = "Código escaneado: " + decodedText;

    // Realizar una solicitud para obtener los datos del usuario
    fetchUserData(decodedText);
  }

  function onScanFailure(error) {
    console.warn(`Escaneo fallido: ${error}`);
  }

  // Función para obtener los datos del usuario usando su ID
  async function fetchUserData(userId) {
    try {
      // Llamar a la API para obtener los datos del usuario por su ID
      const serverUrl = window.location.origin; // Obtiene la URL base del sitio
      const response = await fetch(`${serverUrl}/user/${userId}`);
      if (response.ok) {
        const userData = await response.json();

        // Mostrar los datos del usuario en el frontend
        const userInfoElement = document.getElementById("user-info");
        userInfoElement.innerHTML = `
          <h3>Detalles del Usuario</h3>
          <p><strong>Nombre:</strong> ${userData.name}</p>
          <p><strong>Cargo:</strong> ${userData.role}</p>
          <p><strong>Grupo:</strong> ${userData.group || 'N/A'}</p>
          <p><strong>Edad:</strong> ${userData.age || 'N/A'}</p>
          <p><strong>Teléfono:</strong> ${userData.phone || 'N/A'}</p>
          <p><strong>Alergias:</strong> ${userData.allergies || 'N/A'}</p>
          <p><strong>Tipo de Sangre:</strong> ${userData.bloodType || 'N/A'}</p>
          <p><strong>Talla de playera:</strong> ${userData.shirtSize || 'N/A'}</p>
        `;
      } else {
        console.error('Error al recuperar los datos del usuario');
      }
    } catch (error) {
      console.error('Hubo un error en la solicitud:', error);
    }
  }

  let html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" }, // Usa la cámara trasera si está disponible
    {
      fps: 10, // Velocidad de escaneo en cuadros por segundo
      qrbox: { width: 250, height: 250 } // Tamaño del área de escaneo
    },
    onScanSuccess,
    onScanFailure
  );
</script>